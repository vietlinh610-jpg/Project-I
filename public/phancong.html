<!DOCTYPE html>
<html lang="vi">
<head>
    <title>Qu·∫£n L√Ω Ph√¢n C√¥ng</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark mb-4 shadow">
        <div class="container">
            <span class="navbar-brand fw-bold">üõ°Ô∏è TRANG QU·∫¢N TR·ªä (ADMIN)</span>
            <button onclick="dangXuat()" class="btn btn-outline-light btn-sm fw-bold">ƒêƒÉng Xu·∫•t</button>
        </div>
    </nav>

    <div class="container">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-primary fw-bold text-uppercase">
                <i class="fas fa-calendar-alt me-2"></i> Qu·∫£n L√Ω Ph√¢n C√¥ng
            </h3>
            
            <button class="btn btn-secondary" onclick="history.back()">
                <i class="fas fa-arrow-left me-2"></i>Quay L·∫°i
            </button>
        </div>

        <div class="mb-3 d-flex justify-content-end">
            <button class="btn btn-success fw-bold shadow-sm" onclick="openModal()">
                <i class="fas fa-plus me-1"></i> Th√™m Ph√¢n C√¥ng M·ªõi
            </button>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white fw-bold">
                <i class="fas fa-list me-2"></i> Danh S√°ch Ph√¢n C√¥ng Gi·∫£ng D·∫°y
            </div>
            <div class="card-body p-0">
                <table class="table table-hover table-striped mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3">M√£ PC</th>
                            <th class="py-3">Gi√°o Vi√™n</th>
                            <th class="py-3">L·ªõp</th>
                            <th class="py-3">M√¥n H·ªçc</th>
                            <th class="py-3">H·ªçc K·ª≥ / NƒÉm</th>
                            <th class="py-3">Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalPhanCong" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">Th√™m Ph√¢n C√¥ng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="pc-id"> 
                    
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">Gi√°o Vi√™n:</label>
                        <select id="select-gv" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">L·ªõp H·ªçc:</label>
                        <select id="select-lop" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">M√¥n H·ªçc:</label>
                        <select id="select-mh" class="form-select"></select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="fw-bold text-primary">Ch·ªçn H·ªçc K·ª≥ & NƒÉm H·ªçc:</label>
                        <select id="select-mahk" class="form-select"></select>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="luuPhanCong()">L∆∞u D·ªØ Li·ªáu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const myModal = new bootstrap.Modal(document.getElementById('modalPhanCong'));
        
        // --- 1. KH·ªûI T·∫†O ---
        window.onload = async function() {
            await Promise.all([loadCombobox(), loadTable()]);
        };

        // --- 2. T·∫¢I COMBOBOX ---
        async function loadCombobox() {
            try {
                const [resGV, resLop, resMH, resHK] = await Promise.all([
                    fetch('/api/auth/giaovien'),
                    fetch('/api/lop'),
                    fetch('/api/monhoc'),
                    fetch('/api/hocky') 
                ]);

                const listGV = await resGV.json();
                const listLop = await resLop.json();
                const listMH = await resMH.json();
                const listHK = await resHK.json();

                document.getElementById('select-gv').innerHTML = listGV.map(x => `<option value="${x.Ma_GV}">${x.Ten_GV}</option>`).join('');
                document.getElementById('select-lop').innerHTML = listLop.map(x => `<option value="${x.Ma_Lop}">${x.Ten_Lop}</option>`).join('');
                document.getElementById('select-mh').innerHTML = listMH.map(x => `<option value="${x.Ma_MH}">${x.Ten_MH}</option>`).join('');
                
                document.getElementById('select-mahk').innerHTML = listHK.map(x => 
                    `<option value="${x.Ma_HK}"> ${x.Ten_HK} - NƒÉm ${x.Nam_Hoc}</option>`
                ).join('');

            } catch (e) { console.error("L·ªói t·∫£i combobox:", e); }
        }

        // --- 3. T·∫¢I B·∫¢NG PH√ÇN C√îNG (ƒê√É CƒÇN CH·ªàNH) ---
        async function loadTable() {
            try {
                const res = await fetch('/api/phancong');
                const data = await res.json();
                
                document.getElementById('table-body').innerHTML = data.map(item => `
                    <tr>
                        <td class="fw-bold text-secondary">${item.Ma_PC}</td>
                        <td class="fw-bold text-primary">${item.Ten_GV}</td>
                        
                        <td><span class="badge bg-warning text-dark shadow-sm">${item.Ten_Lop}</span></td>
                        
                        <td>${item.Ten_MH}</td>
                        
                        <td class="text-muted small fw-bold">${item.Hoc_Ky} / ${item.Nam_Hoc}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                onclick="openEditModal('${item.Ma_PC}', '${item.Ma_GV}', '${item.Ma_Lop}', '${item.Ma_MH}', '${item.Ma_HK}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="xoaPhanCong('${item.Ma_PC}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) { alert('L·ªói t·∫£i danh s√°ch!'); }
        }

        // --- 4. X·ª¨ L√ù MODAL ---
        function openModal() {
            document.getElementById('modalTitle').innerText = "Th√™m Ph√¢n C√¥ng";
            document.getElementById('pc-id').value = "";
            myModal.show();
        }

        function openEditModal(id, gv, lop, mh, maHK) {
            document.getElementById('modalTitle').innerText = "S·ª≠a Ph√¢n C√¥ng";
            document.getElementById('pc-id').value = id;
            
            document.getElementById('select-gv').value = gv;
            document.getElementById('select-lop').value = lop;
            document.getElementById('select-mh').value = mh;
            document.getElementById('select-mahk').value = maHK;
            
            myModal.show();
        }

        // --- 5. L∆ØU D·ªÆ LI·ªÜU ---
        async function luuPhanCong() {
            const id = document.getElementById('pc-id').value;
            
            const payload = {
                Ma_GV: document.getElementById('select-gv').value,
                Ma_Lop: document.getElementById('select-lop').value,
                Ma_MH: document.getElementById('select-mh').value,
                Ma_HK: document.getElementById('select-mahk').value 
            };

            const url = id ? `/api/phancong/${id}` : '/api/phancong';
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (res.ok) {
                    alert("‚úÖ Th√†nh c√¥ng!");
                    myModal.hide();
                    loadTable();
                } else {
                    alert("‚ùå L·ªói: " + data.message);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi server"); }
        }

        // --- 6. X√ìA ---
        async function xoaPhanCong(id) {
            if(!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√¢n c√¥ng n√†y?")) return;
            try {
                await fetch(`/api/phancong/${id}`, { method: 'DELETE' });
                loadTable();
            } catch (e) { alert("L·ªói x√≥a!"); }
        }

        // --- 7. ƒêƒÇNG XU·∫§T ---
        function dangXuat() {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>