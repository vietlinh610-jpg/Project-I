<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C·ªïng Th√¥ng Tin H·ªçc Sinh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .card { border: none; }
        .info-label { font-weight: bold; color: #6c757d; min-width: 120px; display: inline-block; }
        .info-value { font-weight: 600; color: #212529; }
        .table th { background-color: #f8f9fa; text-transform: uppercase; font-size: 0.85rem; }
        .diem-kem { color: #dc3545; font-weight: bold; }
        .diem-tot { color: #198754; font-weight: bold; }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark mb-4 shadow">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üéì C·ªîNG TH√îNG TIN H·ªåC SINH</span>
            <button onclick="dangXuat()" class="btn btn-sm btn-outline-light fw-bold">ƒêƒÉng Xu·∫•t</button>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-primary text-white fw-bold">
                <i class="fas fa-user-graduate me-2"></i>TH√îNG TIN H·ªåC SINH
            </div>
            <div class="card-body bg-white rounded-bottom">
                <div class="row g-3" id="thong-tin-hs">
                    <div class="col-md-6 border-end">
                        <p><span class="info-label">M√£ H·ªçc Sinh:</span> <span class="info-value" id="txtMaHS">---</span></p>
                        <p><span class="info-label">H·ªç v√† T√™n:</span> <span class="info-value" id="txtTenHS">---</span></p>
                        <p><span class="info-label">Ng√†y Sinh:</span> <span class="info-value" id="txtNgaySHS">---</span></p>
                        <p><span class="info-label">L·ªõp:</span> <span class="info-value" id="txtTenLop">---</span></p>
                    </div>
                    <div class="col-md-6 ps-md-4">
                        <p><span class="info-label">Gi·ªõi T√≠nh:</span> <span class="info-value" id="txtGioiTinh">---</span></p>
                        <p><span class="info-label">Email:</span> <span class="info-value" id="txtEmail">---</span></p>
                        <p><span class="info-label">S·ªë ƒêT:</span> <span class="info-value" id="txtSDT">---</span></p>
                        <p><span class="info-label">GV Ch·ªß Nhi·ªám:</span> <span class="info-value" id="txtTenGVCN">---</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-success text-white fw-bold">
                <i class="fas fa-file-invoice me-2"></i>K·∫æT QU·∫¢ H·ªåC T·∫¨P CHI TI·∫æT
            </div>
            <div class="card-body p-0 overflow-auto">
                <table class="table table-hover table-bordered mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>H·ªçc K·ª≥</th>
                            <th class="text-start">M√¥n H·ªçc</th>
                            <th>Mi·ªáng</th>
                            <th>15P</th>
                            <th>1 Ti·∫øt</th>
                            <th>Gi·ªØa K·ª≥</th>
                            <th>Cu·ªëi K·ª≥</th>
                            <th>T·ªïng K·∫øt</th>
                        </tr>
                    </thead>
                    <tbody id="bang-diem-body">
                        <tr><td colspan="8" class="py-4 text-muted">ƒêang t·∫£i b·∫£ng ƒëi·ªÉm...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userstr = localStorage.getItem('userCurrent');
        
        if (!userstr) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
            window.location.href = 'login.html';
            return;
        }

        const user = JSON.parse(userstr);
        
        if (user.Loai_TK !== 'HocSinh') {
             alert("T√†i kho·∫£n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p c·ªïng h·ªçc sinh!");
             window.location.href = 'login.html';
             return;
        }

        const maHocSinh = user.Ma_TK; 
        
        layThongTinHS(maHocSinh);
        layBangDiem(maHocSinh);
    });

    //--- L·∫•y b·∫£ng ƒëi·ªÉm c√° nh√¢n ---
    async function layBangDiem(maHS) {
        try {
            const res = await fetch(`/api/hocsinh/canhan/${maHS}`);
            if (!res.ok) throw new Error("L·ªói t·∫£i ƒëi·ªÉm");

            const data = await res.json();
            const tbody = document.getElementById('bang-diem-body');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="py-4">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm h·ªçc t·∫≠p.</td></tr>';
                return;
            }

            data.forEach(d => {
                // ƒê·ªãnh d·∫°ng m√†u ƒëi·ªÉm t·ªïng k·∫øt
                let mauDiem = "";
                if (d.Diem_TK !== null) {
                    mauDiem = d.Diem_TK < 5 ? 'diem-kem' : 'diem-tot';
                }

                const row = `
                <tr>
                    <td class="fw-bold text-secondary">${d.Ten_HK || d.Hoc_Ky}</td>
                    <td class="text-start fw-bold">${d.Ten_MH}</td>
                    <td>${d.Diem_Mieng ?? '-'}</td>
                    <td>${d.Diem_15P ?? '-'}</td>
                    <td>${d.Diem_45P ?? '-'}</td>
                    <td>${d.Diem_GK ?? '-'}</td>
                    <td>${d.Diem_CK ?? '-'}</td>
                    <td class="${mauDiem} fs-5">${d.Diem_TK ?? '-'}</td>
                </tr>
                `;
                tbody.innerHTML += row;
            });

        } catch (error) {
            console.error(error);
            document.getElementById('bang-diem-body').innerHTML = '<tr><td colspan="8" class="text-danger py-4">Kh√¥ng th·ªÉ k·∫øt n·ªëi Server!</td></tr>';
        }
    }

    //--- L·∫•y th√¥ng tin h·ªçc sinh ---
    async function layThongTinHS(maHS) {
        try {
             const res = await fetch(`/api/hocsinh/id/${maHS}`);
             if (!res.ok) throw new Error("L·ªói t·∫£i th√¥ng tin c√° nh√¢n");

             const hs = await res.json();
             
             document.getElementById('txtMaHS').innerText = hs.Ma_HS;
             document.getElementById('txtTenHS').innerText = hs.Ten_HS;
             document.getElementById('txtTenLop').innerText = hs.Ten_Lop || "Ch∆∞a x·∫øp l·ªõp";
             document.getElementById('txtTenGVCN').innerText = hs.Ten_GV || "Ch∆∞a c√≥";
             document.getElementById('txtGioiTinh').innerText = hs.Gioi_Tinh || "---";
             document.getElementById('txtEmail').innerText = hs.Email || "---";
             document.getElementById('txtSDT').innerText = hs.SDT || "---";
             
             if(hs.Ngay_Sinh) {
                document.getElementById('txtNgaySHS').innerText = new Date(hs.Ngay_Sinh).toLocaleDateString('vi-VN');
             }
        } catch (error) {
            console.error(error);
        }
    }

    function dangXuat() {
        if(confirm("X√°c nh·∫≠n ƒëƒÉng xu·∫•t?")) {
            localStorage.removeItem('userCurrent');
            window.location.href = 'login.html';
        }
    }
</script>
</body>
</html>