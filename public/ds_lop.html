<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω L·ªõp H·ªçc</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark mb-4 shadow">
        <div class="container">
            <span class="navbar-brand fw-bold">üõ°Ô∏è TRANG QU·∫¢N TR·ªä (ADMIN)</span>
            <button onclick="dangXuat()" class="btn btn-outline-light btn-sm fw-bold">ƒêƒÉng Xu·∫•t</button>
        </div>
    </nav>

    <div class="container">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-primary fw-bold text-uppercase">
                <i class="fas fa-school me-2"></i> Qu·∫£n L√Ω L·ªõp H·ªçc
            </h3>
            
            <button class="btn btn-secondary" onclick="history.back()">
                <i class="fas fa-arrow-left me-2"></i>Quay L·∫°i
            </button>
        </div>

        <div class="mb-3 d-flex justify-content-end">
            <button class="btn btn-success fw-bold shadow-sm" onclick="openModal()">
                <i class="fas fa-plus me-1"></i> Th√™m L·ªõp M·ªõi
            </button>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white fw-bold">
                <i class="fas fa-list me-2"></i> Danh S√°ch L·ªõp H·ªçc
            </div>
            <div class="card-body p-0">
                <table class="table table-hover table-striped mb-0 text-center align-middle">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3">M√£ L·ªõp</th>
                            <th class="py-3">T√™n L·ªõp</th>
                            <th class="py-3">GV Ch·ªß Nhi·ªám</th>
                            <th class="py-3">Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="bang"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modalLop" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modalTitle">Th√™m L·ªõp M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="lop-id-old">

                    <div class="mb-3">
                        <label class="fw-bold small text-muted">M√£ L·ªõp:</label>
                        <input id="input-ma" class="form-control" placeholder="VD: L10A1">
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">T√™n L·ªõp:</label>
                        <input id="input-ten" class="form-control" placeholder="VD: 10A1">
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold small text-muted">M√£ GVCN:</label>
                        <input id="input-gv" class="form-control" placeholder="Nh·∫≠p m√£ GV (VD: GV001)">
                        <small class="text-danger fst-italic">* M√£ GVCN ph·∫£i t·ªìn t·∫°i trong h·ªá th·ªëng.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="luuLop()">L∆∞u D·ªØ Li·ªáu</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Kh·ªüi t·∫°o Modal
        const myModal = new bootstrap.Modal(document.getElementById('modalLop'));
        let isEdit = false; // Bi·∫øn ki·ªÉm tra ƒëang Th√™m hay S·ª≠a

        // --- 1. T·∫£i danh s√°ch ---
        async function load() {
            try {
                const res = await fetch('/api/lop');
                const data = await res.json();
                
                document.getElementById('bang').innerHTML = data.map(l => `
                    <tr>
                        <td class="fw-bold text-secondary">${l.Ma_Lop}</td>
                        <td class="fw-bold text-primary">${l.Ten_Lop}</td>
                        <td>
                            ${l.Ten_GVCN 
                                ? `<span class="badge bg-success bg-opacity-10 text-success px-3 py-2">${l.Ten_GVCN}</span>` 
                                : (l.Ma_GVCN ? l.Ma_GVCN : '<span class="badge bg-danger bg-opacity-10 text-danger">Ch∆∞a c√≥</span>')}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" 
                                onclick="openEditModal('${l.Ma_Lop}', '${l.Ten_Lop}', '${l.Ma_GVCN || ''}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="xoaLop('${l.Ma_Lop}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) { console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err); }
        }

        // --- 2. M·ªü Modal Th√™m ---
        function openModal() {
            isEdit = false;
            document.getElementById('modalTitle').innerText = "Th√™m L·ªõp M·ªõi";
            document.getElementById('input-ma').value = "";
            document.getElementById('input-ma').disabled = false; // Cho ph√©p nh·∫≠p m√£
            document.getElementById('input-ten').value = "";
            document.getElementById('input-gv').value = "";
            myModal.show();
        }

        // --- 3. M·ªü Modal S·ª≠a (N√¢ng c·∫•p t·ª´ prompt) ---
        function openEditModal(ma, ten, gv) {
            isEdit = true;
            document.getElementById('modalTitle').innerText = "S·ª≠a Th√¥ng Tin L·ªõp";
            document.getElementById('lop-id-old').value = ma; // L∆∞u m√£ c≈©
            
            document.getElementById('input-ma').value = ma;
            document.getElementById('input-ma').disabled = true; // Kh√¥ng cho s·ª≠a m√£ l·ªõp (primary key)
            document.getElementById('input-ten').value = ten;
            document.getElementById('input-gv').value = gv === 'null' ? '' : gv;
            
            myModal.show();
        }

        // --- 4. L∆∞u D·ªØ Li·ªáu (X·ª≠ l√Ω c·∫£ Th√™m v√† S·ª≠a) ---
        async function luuLop() {
            const ma = document.getElementById('input-ma').value.trim();
            const ten = document.getElementById('input-ten').value.trim();
            const gv = document.getElementById('input-gv').value.trim();

            if(!ma || !ten) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß M√£ l·ªõp v√† T√™n l·ªõp!");
                return;
            }

            // X√°c ƒë·ªãnh URL v√† Method d·ª±a tr√™n bi·∫øn isEdit
            const url = isEdit ? `/api/lop/${ma}` : '/api/lop';
            const method = isEdit ? 'PUT' : 'POST';

            const payload = {
                Ma_Lop: ma,
                Ten_Lop: ten,
                Ma_GVCN: gv
            };

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                if (res.ok) {
                    alert("‚úÖ " + (data.message || "Th√†nh c√¥ng!"));
                    myModal.hide(); // ƒê√≥ng modal
                    load(); // T·∫£i l·∫°i b·∫£ng
                } else {
                    alert("‚ùå L·ªñI: " + data.message);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi server!"); }
        }

        // --- 5. X√≥a L·ªõp ---
        async function xoaLop(ma) {
            if(confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp n√†y?\nD·ªØ li·ªáu h·ªçc sinh trong l·ªõp c≈©ng s·∫Ω b·ªã ·∫£nh h∆∞·ªüng.')) {
                try {
                    const res = await fetch(`/api/lop/${ma}`, { method: 'DELETE' });
                    const data = await res.json();
                    if(res.ok) {
                        alert("‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!");
                        load();
                    } else {
                        alert("‚ùå L·ªói: " + data.message);
                    }
                } catch (e) { alert("L·ªói k·∫øt n·ªëi server!"); }
            }
        }

        // --- 6. ƒêƒÉng xu·∫•t ---
        function dangXuat() {
            if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Ch·∫°y h√†m load khi m·ªü trang
        load();
    </script>
</body>
</html>